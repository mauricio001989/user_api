#!/usr/bin/env ruby
require "fileutils"

APP_ROOT = File.expand_path("..", __dir__)

def system!(*)
  system(*, exception: true)
end

FileUtils.chdir APP_ROOT do
  puts '== Installing dependencies =='
  system! 'gem install bundler --conservative'
  system("bundle check") || system!("bundle install")

  puts "\n== Copy .env.example to .env file =="
  system 'cp .env.example .env' unless File.exist?('.env')

  unless ENV['RAILS_ENV'] == 'production'
    puts '== Installing Hooks =='
    system './scripts/install-hooks.sh'
  end

  puts "\n== Preparing database =="
  system! 'bin/rails db:create'
  system! 'bin/rails db:migrate'
  system! 'bin/rails db:seed' unless ENV['RAILS_ENV'] == 'production'

  puts "\n== Removing old logs and tempfiles =="
  system! "bin/rails log:clear tmp:clear"

  if ARGV.include?("--rails-s")
    puts "\n== Starting development server =="
    STDOUT.flush
    exec "bin/dev"
  end

  puts "\n== Restarting application server =="
  system! 'bin/rails restart'
end
